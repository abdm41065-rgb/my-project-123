<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>محاسب</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0c1726;
      --panel:rgba(255,255,255,0.04);
      --panel-strong:rgba(255,255,255,0.08);
      --muted:#94a3b8;
      --text:#f8fafc;
      --accent:#22d3ee;
      --accent-2:#f59e0b;
      --danger:#ef4444;
      --success:#22c55e;
      --radius:14px;
    }
    html{font-size:clamp(14px, 0.9vw + 12px, 18px)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Cairo","Space Grotesk",system-ui;background:radial-gradient(circle at 15% 20%,rgba(34,211,238,0.08),transparent 28%),radial-gradient(circle at 82% 10%,rgba(245,158,11,0.07),transparent 22%),linear-gradient(180deg,#0b1523,#060c15);color:var(--text);-webkit-font-smoothing:antialiased}
    body{padding:18px}
    .shell{width:100%;max-width:1240px;margin:0 auto;display:grid;gap:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;background:var(--panel);padding:14px 16px;border-radius:var(--radius);box-shadow:none;backdrop-filter:blur(8px)}
    .brand{font-weight:800;letter-spacing:-0.3px;color:var(--accent);font-size:18px}
    .budget-display{display:flex;flex-direction:column;gap:4px;padding:12px 18px;border-radius:8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);min-width:280px}
    .budget-label{font-size:12px;color:var(--muted)}
    .budget-value{font-size:28px;font-weight:900;letter-spacing:0.2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.07);background:rgba(255,255,255,0.02);color:var(--text);cursor:pointer;transition:all .2s;font-weight:600}
    .tab.active{background:var(--accent);color:#04101c;border-color:transparent;box-shadow:0 12px 30px rgba(34,211,238,0.25)}
    .tab:hover:not(.active){transform:translateY(-2px);border-color:rgba(255,255,255,0.15)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:var(--text);cursor:pointer;transition:transform .2s ease, box-shadow .2s ease, filter .2s ease;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .btn.primary{background:var(--accent);color:#04101c;border-color:transparent}
    .btn.danger{border-color:rgba(239,68,68,0.4);color:#fecdd3}
    .btn.sell-btn{background:linear-gradient(135deg,#ef4444,#f59e0b);border-color:rgba(239,68,68,0.6);color:#0b1120;box-shadow:0 12px 24px rgba(239,68,68,0.22),0 4px 10px rgba(245,158,11,0.2)}
    .btn.sell-btn:hover{filter:brightness(1.05);transform:translateY(-2px) scale(1.01)}
    .btn.sell-btn:focus{outline:2px solid rgba(239,68,68,0.6)}
    .btn:hover{transform:translateY(-2px);filter:brightness(1.02)}
    .btn:active{transform:translateY(0);filter:brightness(0.98)}
    .btn .icon{font-size:14px;opacity:0.9}
    .layout{display:grid;grid-template-columns:minmax(0,2fr) minmax(0,1fr);gap:16px}
    .panel{background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:none;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.05)}
    h3,h4,h5{margin:0;color:#e2e8f0}
    .muted{color:var(--muted);font-size:13px}
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
    .card{background:var(--panel-strong);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.06);display:flex;flex-direction:column;gap:6px;box-shadow:0 8px 22px rgba(0,0,0,0.15);transition:transform .2s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 18px 40px rgba(0,0,0,0.25)}
    .card .value{font-size:24px;font-weight:900;letter-spacing:0.2px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08)}
    .chart-area{height:clamp(220px, 32vw, 360px);position:relative;margin-top:12px}
    table{width:100%;border-collapse:collapse;color:var(--text)}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.05);text-align:center;font-size:14px}
    th{background:rgba(255,255,255,0.04);font-weight:700}
    .table-wrap{overflow:auto;margin-top:10px;border:1px solid rgba(255,255,255,0.05);border-radius:12px}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin-top:10px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:var(--text);font-family:"Cairo","Space Grotesk";font-size:14px}
    input:focus,select:focus,textarea:focus{outline:2px solid rgba(34,211,238,0.4)}
    .history{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .history-item{padding:10px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;gap:10px}
    .tag{padding:4px 8px;border-radius:8px;font-size:12px}
    .tag.in{background:rgba(34,197,94,0.18);color:#bbf7d0}
    .tag.out{background:rgba(239,68,68,0.16);color:#fecdd3}
    .tag.info{background:rgba(34,211,238,0.16);color:#cffafe}
    .stat-line{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04)}
    .links{display:flex;gap:8px;flex-wrap:wrap}
    .links .btn{padding:8px 10px;font-size:13px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .kpi{font-weight:800;font-size:18px}
    .small{font-size:12px;color:var(--muted)}
    .ai-box{background:rgba(255,255,255,0.03);border:1px dashed rgba(255,255,255,0.12);border-radius:12px;padding:12px;margin-top:10px;display:grid;gap:10px}
    .ai-answer{background:rgba(34,211,238,0.08);border-radius:10px;padding:10px;border:1px solid rgba(34,211,238,0.18);white-space:pre-line}
    .inline-input{padding:6px 8px;font-size:13px}
    .flow-list{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .flow-item{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05)}
    .flow-node{min-width:140px;padding:8px 12px;border-radius:10px;background:rgba(34,211,238,0.12);border:1px solid rgba(34,211,238,0.25);font-weight:700;text-align:center}
    .flow-arrow{flex:1;position:relative;height:24px}
    .flow-arrow svg{width:100%;height:100%}
    .flow-amount{min-width:120px;padding:8px 12px;border-radius:10px;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.35);text-align:center;font-weight:700}
    @media(max-width:980px){
      .layout{grid-template-columns:1fr}
      .topbar{flex-direction:column;align-items:flex-start}
      .chart-area{height:280px}
    }
    @media(max-width:720px){
      body{padding:12px}
      .tabs{width:100%}
      .actions{width:100%;justify-content:flex-start}
      .grid-cards{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
      .history-item{flex-direction:column;align-items:flex-start}
      .chart-area{height:240px}
    }
    @media(max-width:520px){
      .btn{width:100%;justify-content:center}
      .form-grid{grid-template-columns:1fr}
      .chart-area{height:220px}
    }

    /* modal overlay */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:1200;padding:12px;opacity:0;transition:opacity .25s ease}
    .modal-backdrop.show{display:flex;opacity:1}
    .modal{width:900px;max-width:100%;max-height:90vh;overflow:auto;background:linear-gradient(180deg,#0e1a2a,#0a1220);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 30px 90px rgba(0,0,0,0.55);transform:translateY(14px) scale(0.98);opacity:0;transition:transform .25s ease, opacity .25s ease}
    .modal-backdrop.show .modal{transform:translateY(0) scale(1);opacity:1}
    .modal.dark{background:linear-gradient(180deg,#0a0f1a,#0a1424);border-color:rgba(255,255,255,0.12)}
    .modal.dark .panel{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.08)}
    .modal.dark input,.modal.dark select{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.12)}
    .modal.dark select{background:rgba(10,15,26,0.9);color:var(--text)}
    .modal.dark select option{background:#0a0f1a;color:var(--text)}
    .modal header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .modal-close{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.08);color:var(--text);border-radius:10px;padding:8px 10px;cursor:pointer}
  </style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">محاسب</div>
      <div class="budget-display" id="budgetDisplay">
        <div class="budget-label">الميزانية العامة (متبقي)</div>
        <div class="budget-value" id="budgetValue">0 د.ع</div>
      </div>
      <div class="tabs" id="mainTabs">
        <button class="tab active" data-section="dashboard">الرئيسية</button>
        <button class="tab" data-section="products">إدارة المنتجات</button>
        <button class="tab" data-section="personal">مالية العمل</button>
        <button class="tab" data-section="funds">إدارة الأموال</button>
        <button class="tab" data-section="debts">إدارة الديون</button>
      </div>
      <div class="actions">
        <button class="btn" id="resetData"><i class="fa-solid fa-rotate-left icon"></i>تصفير البيانات</button>
      </div>
    </div>

    <section class="panel" id="dashboard" aria-label="لوحة المال الداخل والخارج">
      <div class="layout">
        <div>
          <div class="flex" style="justify-content:space-between;align-items:flex-start">
            <div>
              <h3>تتبع المال (دخل / خرج)</h3>
              <div class="muted">تابع تدفق الأموال للمشاريع الصغيرة مع روابط سريعة للإدارة وتنبيهات تحليلية واضحة.</div>
            </div>
            <div class="links">
              <button class="btn" id="openProductsModal"><i class="fa-solid fa-table-list icon"></i>انتقال للمنتجات</button>
              <button class="btn" data-jump="personal"><i class="fa-solid fa-wallet icon"></i>انتقال لمالية العمل</button>
            </div>
          </div>
          <div class="grid-cards" id="dashCards"></div>
          <div class="panel" style="margin-top:12px">
            <div class="flex" style="justify-content:space-between;align-items:center">
              <h4>المخطط الموحد (المنتجات + المال)</h4>
              <span class="pill">آخر 7 أيام</span>
            </div>
            <div class="chart-area" style="height:320px"><canvas id="mainChart"></canvas></div>
            <div class="history" id="mainChartStats"></div>
          </div>
        </div>

        <aside class="panel">
          <h4>ملخص اليوم</h4>
          <div class="history" id="todayList"></div>
          <div style="margin-top:12px">
            <h5>آخر الحركات</h5>
            <div class="history" id="recentCash"></div>
          </div>
          <div class="panel" style="margin-top:12px">
            <h4>إدارة الميزانية</h4>
            <div class="small" style="margin-top:6px">افتح نافذة الميزانية لإدارة المبالغ بسهولة.</div>
            <button class="btn primary" id="openBudgetModal" style="margin-top:10px"><i class="fa-solid fa-chart-pie icon"></i>فتح نافذة الميزانية</button>
          </div>
        </aside>
      </div>
    </section>

    <section class="panel" id="products" aria-label="إدارة المنتجات" hidden>
      <div class="layout">
        <div>
          <div class="flex" style="justify-content:space-between">
            <h3>المنتجات والمخزون</h3>
            <div class="actions"><button class="btn primary" id="addProduct"><i class="fa-solid fa-plus icon"></i>إضافة منتج</button><button class="btn" id="restockSelected"><i class="fa-solid fa-boxes-stacked icon"></i>إضافة كمية</button><button class="btn danger sell-btn" id="sellSelected"><i class="fa-solid fa-cash-register icon"></i>بيع المنتج</button></div>
          </div>
          <div class="form-grid" id="productForm" style="display:none">
            <input id="pName" placeholder="اسم المنتج">
            <input id="pCategory" placeholder="الفئة">
            <input id="pPrice" type="number" placeholder="السعر">
            <input id="pQty" type="number" placeholder="الكمية المتاحة">
            <button class="btn primary" id="saveProduct"><i class="fa-solid fa-floppy-disk icon"></i>حفظ</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>الاسم</th><th>الفئة</th><th>السعر</th><th>الكمية</th><th>القيمة</th><th>حذف</th></tr></thead>
              <tbody id="productsTable"></tbody>
            </table>
          </div>
          <div class="history" id="inventoryMeta"></div>
        </div>
        <aside>
          <div class="panel">
            <h4>سجل الحركات</h4>
            <div class="history" id="inventoryHistory"></div>
          </div>
          <div class="panel" style="margin-top:12px">
            <h4>لقطات المخزون</h4>
            <div class="history" id="warehouseStats"></div>
          </div>
          <div class="panel" style="margin-top:12px">
            <h4>مراجعة الحركات</h4>
            <div class="small">عرض الحركات حسب اليوم داخل نافذة مستقلة.</div>
            <button class="btn" id="openDailyModal" style="margin-top:8px"><i class="fa-solid fa-calendar-check icon"></i>فتح المراجعة اليومية</button>
          </div>
        </aside>
      </div>
    </section>

    <section class="panel" id="personal" aria-label="مالية العمل" hidden>
      <div class="layout">
        <div>
          <div class="panel">
            <div class="flex" style="justify-content:space-between;align-items:center">
              <h3>مالية العمل</h3>
              <span class="pill">قسم العمل</span>
            </div>
            <div class="form-grid" style="margin-top:10px">
              <select id="ptType"><option value="income">دخل</option><option value="expense">مصروف</option></select>
              <input id="ptAmount" type="number" placeholder="المبلغ">
              <input id="ptDesc" placeholder="الوصف">
              <button class="btn primary" id="addPersonal"><i class="fa-solid fa-plus icon"></i>إضافة</button>
            </div>
          </div>
          <div class="grid-cards" id="personalCards" style="margin-top:12px"></div>
          <div class="panel" style="margin-top:12px">
            <div class="flex" style="justify-content:space-between;align-items:center">
              <h4>منحنى العمل</h4>
              <span class="pill">آخر 10 معاملات</span>
            </div>
            <div class="chart-area" style="height:240px"><canvas id="personalChart"></canvas></div>
          </div>

          
        </div>
        <aside>
          <div class="panel">
            <h4>تفاصيل العمل</h4>
            <div class="history" id="personalList"></div>
          </div>
          <div class="panel" style="margin-top:12px">
            <h4>تحليلات سريعة</h4>
            <div class="history" id="personalPlan"></div>
          </div>
          <div class="panel" style="margin-top:12px">
            <div class="flex" style="justify-content:space-between;align-items:center">
              <h4>ملاحظات عمل مثبتة</h4>
              <span class="pill">قسم العمل</span>
            </div>
            <div class="form-grid">
              <textarea id="noteText" rows="2" placeholder="اكتب ملاحظة خاصة بالعمل أو تذكير مهم"></textarea>
              <button class="btn primary" id="addNote"><i class="fa-solid fa-note-sticky icon"></i>إضافة ملاحظة</button>
            </div>
            <div class="history" id="notesList"></div>
          </div>
        </aside>
      </div>
    </section>

    <section class="panel" id="funds" aria-label="إدارة الأموال" hidden>
      <div class="layout">
        <div>
          <div class="panel">
            <div class="flex" style="justify-content:space-between;align-items:center">
              <div>
                <h3>إدارة الأموال</h3>
                <div class="muted">سجّل أين تذهب الأموال واحسب المتبقي بشكل فوري.</div>
              </div>
              <span class="pill">قسم رابع</span>
            </div>
            <div class="form-grid" style="margin-top:10px">
              <input id="fundsDesc" placeholder="سبب الصرف">
              <input id="fundsAmount" type="number" placeholder="قيمة الصرف">
              <button class="btn primary" id="addFunds"><i class="fa-solid fa-arrow-trend-down icon"></i>تسجيل صرف</button>
            </div>
          </div>
          <div class="panel" style="margin-top:12px">
            <h4>ملخص الأموال</h4>
            <div class="history" id="fundsStats"></div>
          </div>
          <div class="panel" style="margin-top:12px">
            <h4>الخطة المالية</h4>
            <div class="form-grid" style="margin-top:8px">
              <textarea id="fundsPlan" rows="3" placeholder="اكتب خطتك المالية للفترة القادمة"></textarea>
              <button class="btn" id="saveFundsPlan"><i class="fa-solid fa-clipboard-check icon"></i>حفظ الخطة</button>
            </div>
          </div>
        </div>
        <aside class="panel">
          <div class="flex" style="justify-content:space-between;align-items:center">
            <h4>مسار الأموال</h4>
            <span class="pill">أسهم ومربعات</span>
          </div>
          <div class="flow-list" id="fundsFlow"></div>
        </aside>
      </div>
    </section>

    <section class="panel" id="debts" aria-label="إدارة الديون" hidden>
      <div class="layout">
        <div>
          <div class="panel">
            <div class="flex" style="justify-content:space-between;align-items:center">
              <div>
                <h3>إدارة الديون</h3>
                <div class="muted">سجّل الديون وراقب الإجمالي والتفاصيل.</div>
              </div>
              <span class="pill">قسم مستقل</span>
            </div>
            <div class="form-grid" style="margin-top:10px">
              <input id="debtReason" placeholder="سبب الدين">
              <input id="debtTo" placeholder="الجهة الدائنة">
              <input id="debtAmount" type="number" placeholder="قيمة الدين">
              <button class="btn danger" id="addDebt"><i class="fa-solid fa-hand-holding-dollar icon"></i>إضافة دين</button>
            </div>
          </div>
          <div class="panel" style="margin-top:12px">
            <h4>سجل الديون</h4>
            <div class="history" id="debtsList" style="margin-top:10px"></div>
          </div>
        </div>
        <aside class="panel">
          <div class="flex" style="justify-content:space-between;align-items:center">
            <h4>تنبيهات سريعة</h4>
            <span class="pill">ملخص</span>
          </div>
          <div class="history" id="debtsSummary" style="margin-top:10px"></div>
        </aside>
      </div>
    </section>

  </div>

  <!-- نافذة المنتجات السريعة من الرئيسية -->
  <div class="modal-backdrop" id="productsModal" aria-hidden="true">
    <div class="modal">
      <header>
        <div>
          <h3 style="margin:0">إدارة المنتجات (نافذة سريعة)</h3>
          <div class="muted">تحكم كامل بالمنتجات دون مغادرة الصفحة الرئيسية.</div>
        </div>
        <button class="modal-close" id="closeProductsModal">إغلاق</button>
      </header>
      <div class="panel">
        <div class="flex" style="justify-content:space-between">
          <h4>قائمة المنتجات</h4>
          <div class="actions">
            <button class="btn primary" id="addProductModal"><i class="fa-solid fa-plus icon"></i>إضافة منتج</button>
            <button class="btn" id="restockSelectedModal"><i class="fa-solid fa-boxes-stacked icon"></i>إضافة كمية</button>
            <button class="btn danger sell-btn" id="sellSelectedModal"><i class="fa-solid fa-cash-register icon"></i>بيع المنتج</button>
          </div>
        </div>
        <div class="form-grid" id="productFormModal" style="display:none">
          <input id="pNameModal" placeholder="اسم المنتج">
          <input id="pCategoryModal" placeholder="الفئة">
          <input id="pPriceModal" type="number" placeholder="السعر">
          <input id="pQtyModal" type="number" placeholder="الكمية المتاحة">
          <button class="btn primary" id="saveProductModal"><i class="fa-solid fa-floppy-disk icon"></i>حفظ</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>الاسم</th><th>الفئة</th><th>السعر</th><th>الكمية</th><th>القيمة</th><th>حذف</th></tr></thead>
            <tbody id="productsTableModal"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- نافذة بيع منتج (تصميم داكن) -->
  <div class="modal-backdrop" id="sellModal" aria-hidden="true">
    <div class="modal dark">
      <header>
        <div>
          <h3 style="margin:0">بيع منتج</h3>
          <div class="muted">اختر المنتج والكمية، وستُسجَّل الحركة فوراً.</div>
        </div>
        <button class="modal-close" id="closeSellModal">إغلاق</button>
      </header>
      <div class="panel">
        <div class="form-grid">
          <select id="sellProduct"></select>
          <input id="sellQty" type="number" placeholder="الكمية">
          <button class="btn danger" id="confirmSell"><i class="fa-solid fa-circle-check icon"></i>تنفيذ البيع</button>
        </div>
        <div class="small" style="margin-top:8px">تأكد من توفر المخزون قبل التنفيذ.</div>
      </div>
    </div>
  </div>

  <!-- نافذة مراجعة الحركات حسب اليوم -->
  <div class="modal-backdrop" id="dailyModal" aria-hidden="true">
    <div class="modal">
      <header>
        <div>
          <h3 style="margin:0">مراجعة الحركات حسب اليوم</h3>
          <div class="muted">اختر تاريخاً لعرض ما حدث من بيع أو إضافة.</div>
        </div>
        <button class="modal-close" id="closeDailyModal">إغلاق</button>
      </header>
      <div class="panel">
        <div class="form-grid">
          <select id="dateFilter"></select>
          <button class="btn" id="refreshDate">تحديث</button>
        </div>
        <div class="history" id="dailySummary" style="margin-top:10px"></div>
        <div class="history" id="dailyMovements"></div>
      </div>
    </div>
  </div>

  <!-- نافذة إدارة الميزانية -->
  <div class="modal-backdrop" id="budgetModal" aria-hidden="true">
    <div class="modal dark">
      <header>
        <div>
          <h3 style="margin:0">إدارة الميزانية</h3>
          <div class="muted">تعيين الميزانية وزيادتها أو سحب مبلغ منها.</div>
        </div>
        <button class="modal-close" id="closeBudgetModal">إغلاق</button>
      </header>
      <div class="panel">
        <div class="form-grid">
          <input id="fundsBudget" type="number" placeholder="تعيين الميزانية الكلية">
          <button class="btn" id="saveFundsBudget"><i class="fa-solid fa-sack-dollar icon"></i>حفظ الميزانية</button>
        </div>
        <div class="form-grid" style="margin-top:10px">
          <input id="budgetDelta" type="number" placeholder="إضافة/سحب من الميزانية">
          <button class="btn primary" id="addBudget"><i class="fa-solid fa-circle-plus icon"></i>إضافة</button>
          <button class="btn danger" id="subtractBudget"><i class="fa-solid fa-circle-minus icon"></i>سحب</button>
        </div>
        <div class="small" style="margin-top:8px">يمكنك تعديل الميزانية مباشرة أو زيادة/سحب مبلغ.</div>
      </div>
    </div>
  </div>

  <script>
    // state & storage
    const storeKey = 'mini-accounting-state-v2';
    const uid = () => (window.crypto && window.crypto.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(16).slice(2) + Date.now());
    function today(offsetDays=0){ const d = new Date(); d.setDate(d.getDate()+offsetDays); return d.toISOString().slice(0,10); }
    const emptyState = () => ({
      cash: [],
      products: [],
      personal: [],
      personalNotes: [],
      funds: {
        balance: 0,
        allocations: [],
        plan: '',
        budget: 0,
        debts: []
      }
    });
    function normalizeState(data){
      const base = emptyState();
      return {
        ...base,
        ...data,
        cash: Array.isArray(data?.cash) ? data.cash : [],
        products: Array.isArray(data?.products) ? data.products : [],
        personal: Array.isArray(data?.personal) ? data.personal : [],
        personalNotes: Array.isArray(data?.personalNotes) ? data.personalNotes : [],
        funds: {
          balance: Number(data?.funds?.balance || 0),
          allocations: Array.isArray(data?.funds?.allocations) ? data.funds.allocations : [],
          plan: typeof data?.funds?.plan === 'string' ? data.funds.plan : '',
          budget: Number(data?.funds?.budget || 0),
          debts: Array.isArray(data?.funds?.debts) ? data.funds.debts : []
        }
      };
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(storeKey);
        return raw ? normalizeState(JSON.parse(raw)) : emptyState();
      }catch(e){
        return emptyState();
      }
    }
    function saveState(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
    function fmt(amount){ return new Intl.NumberFormat('ar-IQ', {maximumFractionDigits:0}).format(amount) + ' د.ع'; }
    function fmtDate(d){ return new Date(d).toLocaleDateString('ar-IQ', {weekday:'short', month:'short', day:'numeric'}); }
    // helpers
    const toNumber = (value)=>{
      const n = Number(value);
      return Number.isFinite(n) ? n : 0;
    };

    let state = loadState();
    let mainChart, personalChart;

    // tabs
    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      const target = btn.dataset.section;
      document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t===btn));
      document.querySelectorAll('section.panel').forEach(sec=>{sec.hidden = sec.id!==target;});
      if(target==='dashboard') renderDashboard();
      if(target==='products') renderProducts();
      if(target==='personal') renderPersonal();
      if(target==='funds') renderFunds();
      if(target==='debts') renderDebts();
    }));

    // direct navigation buttons
    document.querySelectorAll('[data-jump]').forEach(btn=>btn.addEventListener('click',()=>{
      const target = btn.dataset.jump;
      const tab = document.querySelector(`.tab[data-section="${target}"]`);
      if(tab) tab.click();
    }));

    // modal products
    const productsModal = document.getElementById('productsModal');
    const openProductsModalBtn = document.getElementById('openProductsModal');
    const closeProductsModalBtn = document.getElementById('closeProductsModal');
    const toggleProductsModal = (show)=>{
      if(!productsModal) return;
      productsModal.classList.toggle('show', !!show);
      productsModal.setAttribute('aria-hidden', show? 'false':'true');
      if(show) renderProducts();
    };
    openProductsModalBtn?.addEventListener('click',()=>toggleProductsModal(true));
    closeProductsModalBtn?.addEventListener('click',()=>toggleProductsModal(false));
    productsModal?.addEventListener('click',(e)=>{ if(e.target===productsModal) toggleProductsModal(false); });

    // modal sell
    const sellModal = document.getElementById('sellModal');
    const closeSellModalBtn = document.getElementById('closeSellModal');
    const toggleSellModal = (show, preselectId)=>{
      if(!sellModal) return;
      sellModal.classList.toggle('show', !!show);
      sellModal.setAttribute('aria-hidden', show? 'false':'true');
      if(show) populateSellOptions(preselectId);
    };
    closeSellModalBtn?.addEventListener('click',()=>toggleSellModal(false));
    sellModal?.addEventListener('click',(e)=>{ if(e.target===sellModal) toggleSellModal(false); });

    // modal daily review
    const dailyModal = document.getElementById('dailyModal');
    const openDailyModalBtn = document.getElementById('openDailyModal');
    const closeDailyModalBtn = document.getElementById('closeDailyModal');
    const toggleDailyModal = (show)=>{
      if(!dailyModal) return;
      dailyModal.classList.toggle('show', !!show);
      dailyModal.setAttribute('aria-hidden', show? 'false':'true');
      if(show) renderDailyMovements();
    };
    openDailyModalBtn?.addEventListener('click',()=>toggleDailyModal(true));
    closeDailyModalBtn?.addEventListener('click',()=>toggleDailyModal(false));
    dailyModal?.addEventListener('click',(e)=>{ if(e.target===dailyModal) toggleDailyModal(false); });

    // modal budget
    const budgetModal = document.getElementById('budgetModal');
    const openBudgetModalBtn = document.getElementById('openBudgetModal');
    const closeBudgetModalBtn = document.getElementById('closeBudgetModal');
    const toggleBudgetModal = (show)=>{
      if(!budgetModal) return;
      budgetModal.classList.toggle('show', !!show);
      budgetModal.setAttribute('aria-hidden', show? 'false':'true');
      if(show){
        const budgetInput = document.getElementById('fundsBudget');
        if(budgetInput) budgetInput.value = Number.isFinite(state.funds?.budget) ? state.funds.budget : 0;
      }
    };
    openBudgetModalBtn?.addEventListener('click',()=>toggleBudgetModal(true));
    closeBudgetModalBtn?.addEventListener('click',()=>toggleBudgetModal(false));
    budgetModal?.addEventListener('click',(e)=>{ if(e.target===budgetModal) toggleBudgetModal(false); });

    // dashboard rendering
    function renderDashboard(){
      const cash = state.cash.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
      const totalIn = cash.filter(c=>c.type==='in').reduce((s,c)=>s+c.amount,0);
      const totalOut = cash.filter(c=>c.type==='out').reduce((s,c)=>s+c.amount,0);
      const net = totalIn - totalOut;
      const todayDate = today(0);
      const todayItems = cash.filter(c=>c.date===todayDate);
      const cards = [
        {label:'مال داخل', value: fmt(totalIn), tone:'var(--success)'},
        {label:'مال خارج', value: fmt(totalOut), tone:'var(--danger)'},
        {label:'صافي', value: fmt(net), tone:'var(--accent)'},
        {label:'عمليات اليوم', value: todayItems.length + ' عملية', tone:'var(--accent-2)'}
      ];
      const wrap = document.getElementById('dashCards');
      wrap.innerHTML='';
      cards.forEach(c=>{
        const el = document.createElement('div');
        el.className='card';
        el.style.borderColor = c.tone+'33';
        el.innerHTML = `<div class="muted">${c.label}</div><div class="value" style="color:${c.tone}">${c.value}</div>`;
        wrap.appendChild(el);
      });

      // today summary + recent
      const todayWrap = document.getElementById('todayList'); todayWrap.innerHTML='';
      const todayTotalIn = todayItems.filter(c=>c.type==='in').reduce((s,c)=>s+c.amount,0);
      const todayTotalOut = todayItems.filter(c=>c.type==='out').reduce((s,c)=>s+c.amount,0);
      const todayNet = todayTotalIn - todayTotalOut;
      [
        {label:'دخل اليوم', value:fmt(todayTotalIn), tone:'var(--success)'},
        {label:'صرف اليوم', value:fmt(todayTotalOut), tone:'var(--danger)'},
        {label:'صافي اليوم', value:fmt(todayNet), tone:'var(--accent)'}
      ].forEach(row=>{
        const item = document.createElement('div'); item.className='stat-line'; item.innerHTML=`<div class="muted">${row.label}</div><div class="kpi" style="color:${row.tone}">${row.value}</div>`; todayWrap.appendChild(item);
      });
      const recentWrap = document.getElementById('recentCash'); recentWrap.innerHTML='';
      cash.slice(-6).reverse().forEach(item=>{
        const el = document.createElement('div');
        el.className='history-item';
        el.innerHTML = `
          <div>
            <div class="muted">${fmtDate(item.date)}</div>
            <div>${item.desc}</div>
          </div>
          <div class="flex" style="justify-content:flex-end">
            <span class="kpi" style="color:${item.type==='in'?'var(--success)':'var(--danger)'}">${fmt(item.amount)}</span>
            <button class="btn" data-edit-cash="${item.id}">تعديل</button>
          </div>`;
        recentWrap.appendChild(el);
      });
      recentWrap.querySelectorAll('[data-edit-cash]').forEach(btn=>btn.addEventListener('click',()=>{
        const id = btn.dataset.editCash;
        const item = state.cash.find(c=>c.id===id);
        if(!item) return;
        const nextType = prompt('نوع الحركة (in / out)', item.type) || item.type;
        const nextAmount = Number(prompt('المبلغ', item.amount) || item.amount);
        const nextDesc = prompt('الوصف', item.desc) || item.desc;
        const nextDateRaw = prompt('التاريخ (YYYY-MM-DD)', item.date.slice(0,10)) || item.date.slice(0,10);
        if(isNaN(nextAmount) || nextAmount <= 0) return;
        const nextDate = !isNaN(Date.parse(nextDateRaw)) ? new Date(nextDateRaw).toISOString() : item.date;
        updateCashMovement(id, {
          type: (nextType==='in' || nextType==='out') ? nextType : item.type,
          amount: nextAmount,
          desc: nextDesc,
          date: nextDate
        });
        renderDashboard();
      }));

      renderMainChart();
    }

    // products rendering & actions
    function renderProducts(){
      renderProductsTable('productsTable');
      renderProductsTable('productsTableModal');
      renderInventorySummary();
      renderInventoryHistory();
      renderDailyMovements();
    }
    function renderProductsTable(targetId){
      const tbody = document.getElementById(targetId);
      if(!tbody) return;
      tbody.innerHTML='';
      state.products.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="inline-input" data-field="name" value="${p.name}"></td>
          <td>${p.category||'-'}</td>
          <td><input class="inline-input" data-field="price" type="number" value="${p.price}"></td>
          <td><input class="inline-input" data-field="qty" type="number" value="${p.qty}"></td>
          <td>${fmt(p.price * p.qty)}</td>
          <td><button class="btn danger" data-delete="${p.id}">حذف</button></td>`;
        tr.querySelectorAll('input[data-field]').forEach(input=>{
          input.addEventListener('change',()=>{
            const field = input.dataset.field;
            let value = input.value.trim();
            if(field==='price' || field==='qty'){
              value = Number(value||0);
              if(value < 0) value = 0;
            }
            if(field==='name' && !value){
              input.value = p.name;
              return;
            }
            p[field] = value;
            saveState();
            renderProducts();
            renderDashboard();
          });
        });
        tr.querySelector('[data-delete]').addEventListener('click',()=>{
          state.products = state.products.filter(x=>x.id!==p.id);
          saveState();
          renderProducts();
          renderDashboard();
        });
        tbody.appendChild(tr);
      });
    }
    function renderInventorySummary(){
      const totalValue = state.products.reduce((s,p)=>s+p.price*p.qty,0);
      const totalQty = state.products.reduce((s,p)=>s+p.qty,0);
      const low = state.products.filter(p=>p.qty<10).map(p=>`${p.name} (${p.qty})`);
      const meta = document.getElementById('inventoryMeta'); meta.innerHTML='';
      [
        {label:'إجمالي قيمة المخزون', value:fmt(totalValue)},
        {label:'إجمالي القطع', value:totalQty + ' قطعة'},
        {label:'تنبيه مخزون منخفض', value: low.length? low.join(' ، '):'لا يوجد'}
      ].forEach(row=>{
        const el = document.createElement('div'); el.className='stat-line'; el.innerHTML=`<div class="muted">${row.label}</div><div class="kpi">${row.value}</div>`; meta.appendChild(el);
      });
      const warehouse = document.getElementById('warehouseStats'); warehouse.innerHTML='';
      state.products.forEach(p=>{
        const el = document.createElement('div'); el.className='history-item'; el.innerHTML = `<div><div class="muted">${p.name}</div><div class="small">${p.category||'بدون فئة'}</div></div><div class="kpi">${p.qty} قطعة</div>`; warehouse.appendChild(el);
      });
    }
    function pushHistory(pid, action, qty, dateStr){
      const p = state.products.find(x=>x.id===pid); if(!p) return;
      const date = dateStr ? new Date(dateStr).toISOString() : new Date().toISOString();
      p.history.unshift({ id: uid(), action, qty, date });
      p.history = p.history.slice(0,30);
    }
    function renderInventoryHistory(){
      const list = document.getElementById('inventoryHistory'); list.innerHTML='';
      state.products.flatMap(p=>p.history.map(h=>({p, h}))).sort((a,b)=>new Date(b.h.date)-new Date(a.h.date)).slice(0,12).forEach(entry=>{
        const tagClass = entry.h.action==='بيع'?'out':'in';
        const el = document.createElement('div'); el.className='history-item';
        el.innerHTML = `
          <div>
            <div class="muted">${entry.p.name}</div>
            <div class="small">${fmtDate(entry.h.date)}</div>
          </div>
          <div class="flex" style="justify-content:flex-end">
            <span class="tag ${tagClass}">${entry.h.action}</span>
            <span class="kpi">${entry.h.qty}</span>
            <button class="btn" data-edit-history="${entry.p.id}" data-history-id="${entry.h.id}">تعديل</button>
          </div>`;
        list.appendChild(el);
      });
      list.querySelectorAll('[data-edit-history]').forEach(btn=>btn.addEventListener('click',()=>{
        const productId = btn.dataset.editHistory;
        const historyId = btn.dataset.historyId;
        const p = state.products.find(x=>x.id===productId);
        const h = p?.history?.find(x=>x.id===historyId);
        if(!p || !h) return;
        const nextAction = prompt('نوع الحركة (إضافة / بيع)', h.action) || h.action;
        const nextQty = Number(prompt('الكمية', h.qty) || h.qty);
        const nextDateRaw = prompt('التاريخ (YYYY-MM-DD)', h.date.slice(0,10)) || h.date.slice(0,10);
        if(isNaN(nextQty) || nextQty <= 0) return;
        const action = (nextAction==='إضافة' || nextAction==='بيع') ? nextAction : h.action;
        const nextDate = !isNaN(Date.parse(nextDateRaw)) ? new Date(nextDateRaw).toISOString() : h.date;
        const ok = updateProductHistory(productId, historyId, {action, qty: nextQty, date: nextDate});
        if(!ok) return;
        renderProducts();
        renderDashboard();
      }));
    }
    function monthKey(dateStr){
      const d = new Date(dateStr);
      const m = String(d.getMonth()+1).padStart(2,'0');
      return `${d.getFullYear()}-${m}`;
    }
    function renderDateOptions(){
      const dateSelect = document.getElementById('dateFilter');
      if(!dateSelect) return;
      const dates = state.products
        .flatMap(p=>p.history.map(h=>h.date.slice(0,10)))
        .filter(Boolean);
      const uniqueDates = Array.from(new Set(dates)).sort().reverse();
      if(!uniqueDates.length) uniqueDates.push(today(0));
      dateSelect.innerHTML='';
      const groups = {};
      uniqueDates.forEach(d=>{
        const [y,m] = d.split('-');
        const key = `${y}-${m}`;
        if(!groups[key]) groups[key] = [];
        groups[key].push(d);
      });
      Object.keys(groups).sort().reverse().forEach(key=>{
        const optgroup = document.createElement('optgroup');
        optgroup.label = key;
        groups[key].forEach(d=>{
          const opt = document.createElement('option');
          opt.value = d; opt.textContent = d;
          optgroup.appendChild(opt);
        });
        dateSelect.appendChild(optgroup);
      });
    }
    function renderDailyMovements(){
      renderDateOptions();
      const dateSelect = document.getElementById('dateFilter');
      const summary = document.getElementById('dailySummary');
      const list = document.getElementById('dailyMovements');
      if(!dateSelect || !summary || !list) return;
      const selected = dateSelect.value || today(0);
      const all = state.products.flatMap(p=>p.history.map(h=>({p, h})));
      const filtered = all.filter(e=>e.h.date.slice(0,10)===selected).sort((a,b)=>new Date(b.h.date)-new Date(a.h.date));
      const totalAdd = filtered.filter(e=>e.h.action==='إضافة').reduce((s,e)=>s+e.h.qty,0);
      const totalSell = filtered.filter(e=>e.h.action==='بيع').reduce((s,e)=>s+e.h.qty,0);
      summary.innerHTML='';
      [
        {label:'إجمالي الإضافات', value: totalAdd + ' قطعة', tone:'var(--success)'},
        {label:'إجمالي المبيعات', value: totalSell + ' قطعة', tone:'var(--danger)'},
        {label:'عدد الحركات', value: filtered.length + ' حركة', tone:'var(--accent)'}
      ].forEach(row=>{
        const el = document.createElement('div'); el.className='stat-line';
        el.innerHTML = `<div class="muted">${row.label}</div><div class="kpi" style="color:${row.tone}">${row.value}</div>`;
        summary.appendChild(el);
      });
      list.innerHTML='';
      if(!filtered.length){
        const empty = document.createElement('div');
        empty.className='history-item';
        empty.innerHTML = '<div>لا توجد حركات في هذا اليوم.</div><span class="tag info">معلومات</span>';
        list.appendChild(empty);
        return;
      }
      filtered.slice(0,30).forEach(entry=>{
        const tagClass = entry.h.action==='بيع'?'out':'in';
        const el = document.createElement('div'); el.className='history-item';
        el.innerHTML = `
          <div>
            <div class="muted">${entry.p.name}</div>
            <div class="small">${fmtDate(entry.h.date)}</div>
          </div>
          <div class="flex" style="justify-content:flex-end">
            <span class="tag ${tagClass}">${entry.h.action}</span>
            <span class="kpi">${entry.h.qty}</span>
            <button class="btn" data-edit-history="${entry.p.id}" data-history-id="${entry.h.id}">تعديل</button>
          </div>`;
        list.appendChild(el);
      });
      list.querySelectorAll('[data-edit-history]').forEach(btn=>btn.addEventListener('click',()=>{
        const productId = btn.dataset.editHistory;
        const historyId = btn.dataset.historyId;
        const p = state.products.find(x=>x.id===productId);
        const h = p?.history?.find(x=>x.id===historyId);
        if(!p || !h) return;
        const nextAction = prompt('نوع الحركة (إضافة / بيع)', h.action) || h.action;
        const nextQty = Number(prompt('الكمية', h.qty) || h.qty);
        const nextDateRaw = prompt('التاريخ (YYYY-MM-DD)', h.date.slice(0,10)) || h.date.slice(0,10);
        if(isNaN(nextQty) || nextQty <= 0) return;
        const action = (nextAction==='إضافة' || nextAction==='بيع') ? nextAction : h.action;
        const nextDate = !isNaN(Date.parse(nextDateRaw)) ? new Date(nextDateRaw).toISOString() : h.date;
        const ok = updateProductHistory(productId, historyId, {action, qty: nextQty, date: nextDate});
        if(!ok) return;
        renderProducts();
        renderDashboard();
      }));
    }
    function populateSellOptions(preselectId){
      const select = document.getElementById('sellProduct');
      if(!select) return;
      select.innerHTML='';
      if(!state.products.length){
        const opt = document.createElement('option');
        opt.value=''; opt.textContent='لا توجد منتجات';
        select.appendChild(opt);
        return;
      }
      state.products.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id; opt.textContent = p.name;
        if(preselectId && preselectId===p.id) opt.selected = true;
        select.appendChild(opt);
      });
    }
    function renderWeeklyReports(){
      const wrap = document.getElementById('weeklyReports');
      const range = document.getElementById('weeklyRange');
      if(!wrap) return;
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate()-6);
      start.setHours(0,0,0,0);
      end.setHours(23,59,59,999);
      const startLabel = start.toLocaleDateString('ar-IQ');
      const endLabel = end.toLocaleDateString('ar-IQ');
      if(range) range.textContent = `${startLabel} - ${endLabel}`;
      const totals = new Map();
      state.products.forEach(p=>totals.set(p.id, {p, qty:0}));
      state.products.forEach(p=>{
        (p.history||[]).forEach(h=>{
          if(h.action!=='بيع') return;
          const d = new Date(h.date);
          if(d>=start && d<=end){
            totals.get(p.id).qty += h.qty;
          }
        });
      });
      const items = Array.from(totals.values());
      const sold = items.filter(i=>i.qty>0);
      const totalSold = sold.reduce((s,i)=>s+i.qty,0);
      wrap.innerHTML='';
      if(!sold.length){
        const el = document.createElement('div');
        el.className='history-item';
        el.innerHTML = '<div>لا توجد مبيعات خلال آخر 7 أيام.</div><span class="tag info">تقرير</span>';
        wrap.appendChild(el);
        return;
      }
      const most = sold.slice().sort((a,b)=>b.qty-a.qty)[0];
      const least = sold.slice().sort((a,b)=>a.qty-b.qty)[0];
      [
        {label:'الأكثر مبيعاً', value:`${most.p.name} (${most.qty} قطعة)`},
        {label:'الأقل مبيعاً', value:`${least.p.name} (${least.qty} قطعة)`},
        {label:'إجمالي المبيعات الأسبوعية', value:`${totalSold} قطعة`}
      ].forEach(row=>{
        const el = document.createElement('div');
        el.className='stat-line';
        el.innerHTML = `<div class="muted">${row.label}</div><div class="kpi">${row.value}</div>`;
        wrap.appendChild(el);
      });
    }
    function renderMainChart(){
      const stats = document.getElementById('mainChartStats');
      const canvas = document.getElementById('mainChart');
      if(!stats || !canvas) return;
      const days = [];
      for(let i=6;i>=0;i--){ days.push(today(-i)); }
      const cashIn = days.map(d=> state.cash.filter(c=>c.date===d && c.type==='in').reduce((s,c)=>s+c.amount,0));
      const cashOut = days.map(d=> state.cash.filter(c=>c.date===d && c.type==='out').reduce((s,c)=>s+c.amount,0));
      const addSeries = days.map(d=>{
        return state.products.flatMap(p=>p.history||[])
          .filter(h=>h.action==='إضافة' && h.date.slice(0,10)===d)
          .reduce((s,h)=>s+h.qty,0);
      });
      const sellSeries = days.map(d=>{
        return state.products.flatMap(p=>p.history||[])
          .filter(h=>h.action==='بيع' && h.date.slice(0,10)===d)
          .reduce((s,h)=>s+h.qty,0);
      });
      const labels = days.map(d=> new Date(d).toLocaleDateString('ar-IQ',{weekday:'short'}));
      if(mainChart) mainChart.destroy();
      if(window.Chart){
        const ctx = canvas.getContext('2d');
        mainChart = new Chart(ctx, {
          type:'bar',
          data:{labels, datasets:[
            {label:'إضافات المنتجات', data:addSeries, backgroundColor:'rgba(34,197,94,0.55)', borderRadius:8, yAxisID:'y1'},
            {label:'مبيعات المنتجات', data:sellSeries, backgroundColor:'rgba(239,68,68,0.55)', borderRadius:8, yAxisID:'y1'},
            {label:'مال داخل', data:cashIn, type:'line', borderColor:'rgba(34,197,94,0.95)', backgroundColor:'rgba(34,197,94,0.12)', tension:0.35, fill:true, pointRadius:3, yAxisID:'y'},
            {label:'مال خارج', data:cashOut, type:'line', borderColor:'rgba(239,68,68,0.95)', backgroundColor:'rgba(239,68,68,0.12)', tension:0.35, fill:true, pointRadius:3, yAxisID:'y'}
          ]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            interaction:{mode:'index', intersect:false},
            animation:{duration:800, easing:'easeOutQuart'},
            transitions:{active:{animation:{duration:300}}},
            plugins:{
              legend:{labels:{color:'#e2e8f0'}},
              tooltip:{callbacks:{label:(ctx)=>{
                if(ctx.dataset.yAxisID==='y1') return `${ctx.dataset.label}: ${ctx.parsed.y} قطعة`;
                return `${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`;
              }}}
            },
            scales:{
              x:{ticks:{color:'var(--muted)'}},
              y:{position:'left', ticks:{color:'var(--muted)'}},
              y1:{position:'right', ticks:{color:'var(--muted)'}, grid:{drawOnChartArea:false}}
            }
          }
        });
      }
      const totalAdd = addSeries.reduce((s,v)=>s+v,0);
      const totalSell = sellSeries.reduce((s,v)=>s+v,0);
      const totalIn = cashIn.reduce((s,v)=>s+v,0);
      const totalOut = cashOut.reduce((s,v)=>s+v,0);
      stats.innerHTML='';
      [
        {label:'إجمالي الإضافات (7 أيام)', value: totalAdd + ' قطعة', tone:'var(--success)'},
        {label:'إجمالي المبيعات (7 أيام)', value: totalSell + ' قطعة', tone:'var(--danger)'},
        {label:'مال داخل (7 أيام)', value: fmt(totalIn), tone:'var(--success)'},
        {label:'مال خارج (7 أيام)', value: fmt(totalOut), tone:'var(--danger)'}
      ].forEach(row=>{
        const el = document.createElement('div');
        el.className='stat-line';
        el.innerHTML = `<div class="muted">${row.label}</div><div class="kpi" style="color:${row.tone}">${row.value}</div>`;
        stats.appendChild(el);
      });
    }
    // product form toggle
    document.getElementById('addProduct').addEventListener('click',()=>{
      const form = document.getElementById('productForm'); form.style.display = form.style.display==='none'?'grid':'none';
    });
    document.getElementById('addProductModal').addEventListener('click',()=>{
      const form = document.getElementById('productFormModal'); form.style.display = form.style.display==='none'?'grid':'none';
    });
    document.getElementById('saveProduct').addEventListener('click',()=>{
      const name = document.getElementById('pName').value.trim();
      const cat = document.getElementById('pCategory').value.trim();
      const price = toNumber(document.getElementById('pPrice').value||0);
      const qty = toNumber(document.getElementById('pQty').value||0);
      if(!name||price<=0||qty<0){alert('أدخل بيانات صحيحة');return;}
      state.products.push({id:uid(), name, category:cat, price, qty, history:[]});
      saveState();
      renderProducts();
      document.getElementById('productForm').style.display='none';
      ['pName','pCategory','pPrice','pQty'].forEach(id=>document.getElementById(id).value='');
    });
    document.getElementById('saveProductModal').addEventListener('click',()=>{
      const name = document.getElementById('pNameModal').value.trim();
      const cat = document.getElementById('pCategoryModal').value.trim();
      const price = toNumber(document.getElementById('pPriceModal').value||0);
      const qty = toNumber(document.getElementById('pQtyModal').value||0);
      if(!name||price<=0||qty<0){alert('أدخل بيانات صحيحة');return;}
      state.products.push({id:uid(), name, category:cat, price, qty, history:[]});
      saveState();
      renderProducts();
      document.getElementById('productFormModal').style.display='none';
      ['pNameModal','pCategoryModal','pPriceModal','pQtyModal'].forEach(id=>document.getElementById(id).value='');
    });
    function restockFlow(){
      if(!state.products.length){alert('لا توجد منتجات');return;}
      const names = state.products.map(p=>p.name).join('، ');
      const name = prompt(`اختر المنتج بالاسم:\n${names}`);
      if(!name) return;
      const p = state.products.find(x=>x.name===name.trim());
      if(!p){alert('المنتج غير موجود');return;}
      const qty = toNumber(prompt('كمية الإضافة؟','5'));
      if(qty<=0) return;
      p.qty += qty;
      pushHistory(p.id, 'إضافة', qty);
      saveState();
      renderProducts();
      renderDashboard();
    }
    document.getElementById('restockSelected').addEventListener('click',()=>{
      restockFlow();
    });
    document.getElementById('restockSelectedModal').addEventListener('click',()=>{
      restockFlow();
    });
    document.getElementById('sellSelected').addEventListener('click',()=>{
      toggleSellModal(true);
      document.getElementById('sellQty').value='';
    });
    document.getElementById('sellSelectedModal').addEventListener('click',()=>{
      toggleSellModal(true);
      document.getElementById('sellQty').value='';
    });
    document.getElementById('confirmSell').addEventListener('click',()=>{
      const productId = document.getElementById('sellProduct').value;
      const qty = toNumber(document.getElementById('sellQty').value||0);
      if(!productId){alert('اختر منتجاً');return;}
      if(isNaN(qty)||qty<=0){alert('أدخل كمية صحيحة');return;}
      const p = state.products.find(x=>x.id===productId);
      if(!p){alert('المنتج غير موجود');return;}
      if(qty>p.qty){alert('لا يوجد مخزون كافٍ');return;}
      const saleAmount = qty * (p.price || 0);
      p.qty -= qty;
      pushHistory(p.id, 'بيع', qty);
      if(saleAmount > 0){
        state.cash.push({
          id: uid(),
          type: 'in',
          amount: saleAmount,
          desc: `بيع منتج: ${p.name}`,
          date: today(0)
        });
      }
      saveState();
      renderProducts();
      renderDashboard();
      toggleSellModal(false);
    });
    document.getElementById('refreshDate').addEventListener('click',()=>{
      renderDailyMovements();
    });
    document.getElementById('dateFilter').addEventListener('change',()=>{
      renderDailyMovements();
    });

    // personal finances
    function renderPersonal(){
      const list = state.personal.slice().sort((a,b)=>new Date(b.date)-new Date(a.date));
      const totalIncome = list.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
      const totalExpense = list.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
      const net = totalIncome - totalExpense;
      const cards = document.getElementById('personalCards'); cards.innerHTML='';
      [
        {label:'إجمالي الدخل', value:fmt(totalIncome), tone:'var(--success)'},
        {label:'إجمالي المصروف', value:fmt(totalExpense), tone:'var(--danger)'},
        {label:'صافي العمل', value:fmt(net), tone:'var(--accent)'},
        {label:'عدد العمليات', value:list.length + ' حركة', tone:'var(--accent-2)'}
      ].forEach(c=>{ const el=document.createElement('div'); el.className='card'; el.style.borderColor=c.tone+'33'; el.innerHTML=`<div class="muted">${c.label}</div><div class="value" style="color:${c.tone}">${c.value}</div>`; cards.appendChild(el); });
      const history = document.getElementById('personalList'); history.innerHTML='';
      list.slice(0,10).forEach(tx=>{
        const el=document.createElement('div'); el.className='history-item';
        el.innerHTML = `
          <div>
            <div class="muted">${fmtDate(tx.date)}</div>
            <div>${tx.desc}</div>
          </div>
          <div class="flex" style="justify-content:flex-end">
            <span class="kpi" style="color:${tx.type==='income'?'var(--success)':'var(--danger)'}">${fmt(tx.amount)}</span>
            <button class="btn" data-edit-personal="${tx.id}">تعديل</button>
          </div>`;
        history.appendChild(el);
      });
      history.querySelectorAll('[data-edit-personal]').forEach(btn=>btn.addEventListener('click',()=>{
        const id = btn.dataset.editPersonal;
        const tx = state.personal.find(t=>t.id===id);
        if(!tx) return;
        const nextType = prompt('النوع (income / expense)', tx.type) || tx.type;
        const nextAmount = Number(prompt('المبلغ', tx.amount) || tx.amount);
        const nextDesc = prompt('الوصف', tx.desc) || tx.desc;
        const nextDateRaw = prompt('التاريخ (YYYY-MM-DD)', tx.date.slice(0,10)) || tx.date.slice(0,10);
        if(isNaN(nextAmount) || nextAmount <= 0) return;
        const nextDate = !isNaN(Date.parse(nextDateRaw)) ? new Date(nextDateRaw).toISOString() : tx.date;
        updatePersonalMovement(id, {
          type: (nextType==='income' || nextType==='expense') ? nextType : tx.type,
          amount: nextAmount,
          desc: nextDesc,
          date: nextDate
        });
        renderPersonal();
      }));
      const plan = document.getElementById('personalPlan'); plan.innerHTML='';
      plan.innerHTML = `
        <div class="stat-line"><div class="muted">مبلغ توفير تفصيلي</div><div class="kpi">${fmt(net>0? net*0.2: 50000)}</div></div>
        <div class="stat-line"><div class="muted">مصاريف يمكن خفضها</div><div class="kpi">${fmt(totalExpense*0.1)}</div></div>`;
      renderPersonalChart(list);
      renderPersonalNotes();
    }
    function renderPersonalChart(list){
      if(personalChart) personalChart.destroy();
      const slice = list.slice(-10).reverse();
      const labels = slice.map(t=>fmtDate(t.date));
      const income = slice.map(t=> t.type==='income'? t.amount:0);
      const expense = slice.map(t=> t.type==='expense'? t.amount:0);
      if(window.Chart){
        const ctx = document.getElementById('personalChart').getContext('2d');
        personalChart = new Chart(ctx, {
          type:'bar',
          data:{labels, datasets:[
            {label:'دخل', data:income, backgroundColor:'rgba(34,197,94,0.65)', borderRadius:8},
            {label:'مصروف', data:expense, backgroundColor:'rgba(239,68,68,0.65)', borderRadius:8}
          ]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            interaction:{mode:'index', intersect:false},
            animation:{duration:700, easing:'easeOutQuart'},
            plugins:{
              legend:{labels:{color:'#e2e8f0'}},
              tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`}}
            },
            scales:{x:{ticks:{color:'var(--muted)'}}, y:{ticks:{color:'var(--muted)'}}}
          }
        });
      }
    }
    document.getElementById('addPersonal').addEventListener('click',()=>{
      const type = document.getElementById('ptType').value;
      const amount = toNumber(document.getElementById('ptAmount').value||0);
      const desc = document.getElementById('ptDesc').value.trim()|| (type==='income'?'دخل عمل':'مصروف عمل');
      if(amount<=0){alert('أدخل مبلغ صحيح');return;}
      state.personal.push({id:uid(), type, amount, desc, date: today(0)});
      saveState(); renderPersonal();
      document.getElementById('ptAmount').value=''; document.getElementById('ptDesc').value='';
    });

    function updateCashMovement(id, updates){
      const item = state.cash.find(c=>c.id===id);
      if(!item) return;
      item.type = updates.type ?? item.type;
      item.amount = updates.amount ?? item.amount;
      item.desc = updates.desc ?? item.desc;
      item.date = updates.date ?? item.date;
      saveState();
    }
    function updatePersonalMovement(id, updates){
      const item = state.personal.find(p=>p.id===id);
      if(!item) return;
      item.type = updates.type ?? item.type;
      item.amount = updates.amount ?? item.amount;
      item.desc = updates.desc ?? item.desc;
      item.date = updates.date ?? item.date;
      saveState();
    }
    function impactFor(action, qty){
      if(action==='إضافة') return qty;
      if(action==='بيع') return -qty;
      return 0;
    }
    function updateProductHistory(productId, historyId, updates){
      const p = state.products.find(x=>x.id===productId);
      const h = p?.history?.find(x=>x.id===historyId);
      if(!p || !h) return false;
      const oldImpact = impactFor(h.action, h.qty);
      const nextAction = updates.action ?? h.action;
      const nextQty = updates.qty ?? h.qty;
      const newImpact = impactFor(nextAction, nextQty);
      const diff = newImpact - oldImpact;
      if(p.qty + diff < 0){
        alert('لا يوجد مخزون كافٍ بعد التعديل.');
        return false;
      }
      p.qty += diff;
      h.action = nextAction;
      h.qty = nextQty;
      h.date = updates.date ?? h.date;
      saveState();
      return true;
    }

    function renderBudgetHeader(){
      const budgetValue = document.getElementById('budgetValue');
      if(!budgetValue) return;
      const budget = Number(state.funds?.budget || 0);
      const allocations = Array.isArray(state.funds?.allocations) ? state.funds.allocations : [];
      const totalSpent = allocations.reduce((s,a)=>s+a.amount,0);
      const budgetRemaining = budget - totalSpent;
      budgetValue.textContent = fmt(budgetRemaining);
      budgetValue.style.color = budgetRemaining >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    function renderFunds(){
      const stats = document.getElementById('fundsStats');
      const planInput = document.getElementById('fundsPlan');
      const flow = document.getElementById('fundsFlow');
      const budgetInput = document.getElementById('fundsBudget');
      if(!stats || !planInput || !flow) return;

      const balance = Number(state.funds?.balance || 0);
      const budget = Number(state.funds?.budget || 0);
      const allocations = Array.isArray(state.funds?.allocations) ? state.funds.allocations : [];
      const totalSpent = allocations.reduce((s,a)=>s+a.amount,0);
      const remaining = balance - totalSpent;
      const budgetRemaining = budget - totalSpent;

      stats.innerHTML='';
      [
        {label:'إجمالي المصروفات', value: fmt(totalSpent), tone:'var(--danger)'},
        {label:'المتبقي من الرصيد', value: fmt(remaining), tone: remaining>=0 ? 'var(--success)' : 'var(--danger)'},
        {label:'ميزانية متبقية', value: fmt(budgetRemaining), tone: budgetRemaining>=0 ? 'var(--success)' : 'var(--danger)'}
      ].forEach(row=>{
        const el = document.createElement('div');
        el.className='stat-line';
        el.innerHTML = `<div class="muted">${row.label}</div><div class="kpi" style="color:${row.tone}">${row.value}</div>`;
        stats.appendChild(el);
      });

      planInput.value = state.funds?.plan || '';
      if(budgetInput) budgetInput.value = Number.isFinite(budget) ? budget : 0;
      renderBudgetHeader();
      flow.innerHTML='';
      if(!allocations.length){
        const empty = document.createElement('div');
        empty.className='history-item';
        empty.innerHTML = '<div>لا توجد مصروفات مسجلة بعد.</div><span class="tag info">تنبيه</span>';
        flow.appendChild(empty);
        return;
      }
      allocations.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(a=>{
        const item = document.createElement('div');
        item.className='flow-item';
        item.innerHTML = `
          <div class="flow-node">${a.desc || 'مصروف'}</div>
          <div class="flow-arrow" aria-hidden="true">
            <svg viewBox="0 0 200 40" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2 30 C60 2, 140 2, 198 30" stroke="rgba(245,158,11,0.8)" stroke-width="3" stroke-linecap="round"/>
              <path d="M190 24 L198 30 L190 36" stroke="rgba(245,158,11,0.8)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="flow-amount">${fmt(a.amount)}</div>`;
        flow.appendChild(item);
      });

    }

    function renderDebts(){
      const debtsList = document.getElementById('debtsList');
      const debtsSummary = document.getElementById('debtsSummary');
      if(!debtsList) return;
      const debts = Array.isArray(state.funds?.debts) ? state.funds.debts : [];
      debtsList.innerHTML='';
      if(!debts.length){
        const empty = document.createElement('div');
        empty.className='history-item';
        empty.innerHTML = '<div>لا توجد ديون مسجلة.</div><span class="tag info">معلومات</span>';
        debtsList.appendChild(empty);
      }else{
        debts.forEach(d=>{
          const el = document.createElement('div');
          el.className='history-item';
          el.innerHTML = `
            <div>
              <div class="muted">${d.reason || 'دين'}</div>
              <div class="small">${d.to || 'غير محدد'} • ${fmtDate(d.date || today(0))}</div>
            </div>
            <div class="flex" style="justify-content:flex-end">
              <span class="kpi" style="color:var(--danger)">${fmt(d.amount)}</span>
              <button class="btn danger" data-del-debt="${d.id}">حذف</button>
            </div>`;
          debtsList.appendChild(el);
        });
        debtsList.querySelectorAll('[data-del-debt]').forEach(btn=>btn.addEventListener('click',()=>{
          const id = btn.dataset.delDebt;
          state.funds.debts = state.funds.debts.filter(x=>x.id!==id);
          saveState();
          renderDebts();
        }));
      }
      if(debtsSummary){
        debtsSummary.innerHTML='';
        const totalDebt = debts.reduce((s,d)=>s + (Number(d.amount)||0),0);
        const count = debts.length;
        const latest = debts.slice().sort((a,b)=>new Date(b.date||0)-new Date(a.date||0))[0];
        [
          {label:'إجمالي الديون', value: fmt(totalDebt), tone:'var(--danger)'},
          {label:'عدد الديون', value: count + ' دين', tone:'var(--accent)'},
          {label:'آخر دين', value: latest ? `${latest.reason || 'دين'} (${fmtDate(latest.date || today(0))})` : 'لا يوجد', tone:'var(--muted)'}
        ].forEach(row=>{
          const el = document.createElement('div');
          el.className='stat-line';
          el.innerHTML = `<div class="muted">${row.label}</div><div class="kpi" style="color:${row.tone}">${row.value}</div>`;
          debtsSummary.appendChild(el);
        });
      }
    }

    document.getElementById('addFunds')?.addEventListener('click',()=>{
      const desc = document.getElementById('fundsDesc').value.trim();
      const amount = toNumber(document.getElementById('fundsAmount').value||0);
      if(amount<=0){alert('أدخل مبلغ صحيح');return;}
      const entry = {id: uid(), desc, amount, date: today(0)};
      state.funds.allocations.unshift(entry);
      saveState();
      document.getElementById('fundsDesc').value='';
      document.getElementById('fundsAmount').value='';
      renderFunds();
      renderBudgetHeader();
      toggleBudgetModal(false);
    });
    document.getElementById('saveFundsPlan')?.addEventListener('click',()=>{
      const text = document.getElementById('fundsPlan').value.trim();
      state.funds.plan = text;
      saveState();
      renderFunds();
    });
    document.getElementById('saveFundsBudget')?.addEventListener('click',()=>{
      const amount = toNumber(document.getElementById('fundsBudget').value||0);
      state.funds.budget = amount;
      saveState();
      renderFunds();
      renderBudgetHeader();
      toggleBudgetModal(false);
    });
    document.getElementById('addBudget')?.addEventListener('click',()=>{
      const delta = toNumber(document.getElementById('budgetDelta').value||0);
      if(delta<=0){alert('أدخل مبلغ صحيح');return;}
      state.funds.budget = toNumber(state.funds.budget) + delta;
      saveState();
      document.getElementById('budgetDelta').value='';
      renderFunds();
      renderBudgetHeader();
      toggleBudgetModal(false);
    });
    document.getElementById('subtractBudget')?.addEventListener('click',()=>{
      const delta = toNumber(document.getElementById('budgetDelta').value||0);
      if(delta<=0){alert('أدخل مبلغ صحيح');return;}
      state.funds.budget = toNumber(state.funds.budget) - delta;
      saveState();
      document.getElementById('budgetDelta').value='';
      renderFunds();
      renderBudgetHeader();
    });
    document.getElementById('addDebt')?.addEventListener('click',()=>{
      const reason = document.getElementById('debtReason').value.trim();
      const to = document.getElementById('debtTo').value.trim();
      const amount = toNumber(document.getElementById('debtAmount').value||0);
      if(amount<=0){alert('أدخل مبلغ دين صحيح');return;}
      const entry = {id: uid(), reason, to, amount, date: today(0)};
      state.funds.debts.unshift(entry);
      saveState();
      document.getElementById('debtReason').value='';
      document.getElementById('debtTo').value='';
      document.getElementById('debtAmount').value='';
      renderDebts();
    });

    function renderPersonalNotes(){
      const list = document.getElementById('notesList');
      if(!list) return;
      const notes = state.personalNotes.slice().sort((a,b)=>{
        if(a.pinned===b.pinned) return new Date(b.date)-new Date(a.date);
        return a.pinned ? -1 : 1;
      });
      list.innerHTML='';
      if(!notes.length){
        const empty = document.createElement('div');
        empty.className='history-item';
        empty.innerHTML = '<div>لا توجد ملاحظات بعد.</div><span class="tag info">ملاحظة</span>';
        list.appendChild(empty);
        return;
      }
      notes.forEach(note=>{
        const el = document.createElement('div');
        el.className='history-item';
        el.innerHTML = `
          <div>
            <div class="muted">${fmtDate(note.date)}</div>
            <div>${note.text}</div>
          </div>
          <div class="flex">
            <button class="btn" data-pin="${note.id}">${note.pinned ? 'مثبت' : 'تثبيت'}</button>
            <button class="btn danger" data-del="${note.id}">حذف</button>
          </div>`;
        list.appendChild(el);
      });
      list.querySelectorAll('[data-pin]').forEach(btn=>btn.addEventListener('click',()=>{
        const id = btn.dataset.pin;
        const note = state.personalNotes.find(n=>n.id===id);
        if(!note) return;
        note.pinned = !note.pinned;
        saveState();
        renderPersonalNotes();
      }));
      list.querySelectorAll('[data-del]').forEach(btn=>btn.addEventListener('click',()=>{
        const id = btn.dataset.del;
        state.personalNotes = state.personalNotes.filter(n=>n.id!==id);
        saveState();
        renderPersonalNotes();
      }));
    }
    document.getElementById('addNote').addEventListener('click',()=>{
      const text = document.getElementById('noteText').value.trim();
      if(!text){alert('اكتب الملاحظة أولاً');return;}
      state.personalNotes.unshift({id:uid(), text, pinned:false, date: today(0)});
      saveState();
      document.getElementById('noteText').value='';
      renderPersonalNotes();
    });

    // data export & reset
    document.getElementById('resetData').addEventListener('click',()=>{
      if(!confirm('هل تريد تصفير البيانات وإعادة القيم الافتراضية؟')) return;
      state = emptyState(); saveState(); renderDashboard(); renderProducts(); renderPersonal();
    });


    // bootstrap
    renderDashboard();
    renderProducts();
    renderPersonal();
    renderFunds();
    renderDebts();
    renderBudgetHeader();
  </script>
</body>
</html>
